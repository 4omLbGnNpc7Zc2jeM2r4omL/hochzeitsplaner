{% extends "base.html" %}

{% block title %}Gästezugänge - {{ super() }}{% endblock %}

{% block page_title %}
<div class="d-flex justify-content-between align-items-center">
    <div>
        <h1 class="h3 mb-0">
            <i class="bi bi-key-fill text-warning me-2"></i>
            Gästezugänge
        </h1>
        <p class="text-muted mb-0">Verwaltung der Login-Credentials für Gäste</p>
    </div>
</div>
{% endblock %}

{% block additional_css %}
<style>
    .credential-card {
        transition: all 0.3s ease;
        border: 1px solid #e9ecef;
    }
    .credential-card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }
    .copy-btn {
        font-size: 0.8rem;
        transition: all 0.2s ease;
    }
    .copy-btn:hover {
        transform: scale(1.05);
    }
    .generated-credential {
        font-family: 'Courier New', monospace;
        background-color: #f8f9fa;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        border: 1px solid #dee2e6;
    }
    .search-highlight {
        background-color: #fff3cd;
        padding: 0.1rem 0.2rem;
        border-radius: 0.2rem;
        font-weight: bold;
    }
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
    }
    .action-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border: none;
    }
    .table-responsive {
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    .btn-action {
        border-radius: 50px;
        padding: 0.25rem 0.75rem;
    }
</style>
{% endblock %}
{% block content %}
<div class="row mb-4">
    <!-- Statistiken -->
    <div class="col-md-6">
        <div class="card stats-card h-100">
            <div class="card-body text-center">
                <h2 class="display-4 fw-bold mb-2" id="totalGuests">-</h2>
                <p class="mb-1">Gäste insgesamt</p>
                <small class="opacity-75">
                    <span id="credentialsGenerated">-</span> mit Zugangsdaten
                </small>
            </div>
        </div>
    </div>
    
    <!-- Aktionen -->
    <div class="col-md-6">
        <div class="card action-card h-100">
            <div class="card-body d-flex flex-column justify-content-center">
                <h5 class="card-title mb-3">
                    <i class="bi bi-tools me-2"></i>
                    Verwaltungsaktionen
                </h5>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-light btn-action" id="generateCredentials">
                        <i class="bi bi-key me-2"></i>
                        Alle Credentials generieren
                    </button>
                    <button type="button" class="btn btn-outline-light btn-action" id="refreshCredentials">
                        <i class="bi bi-arrow-clockwise me-2"></i>
                        Aktualisieren
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Suchbereich -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" class="form-control" id="searchInput" 
                                   placeholder="Gast suchen (Name, E-Mail oder Code)...">
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                                            </div>
                    <div class="ms-auto">
                        <button type="button" class="btn btn-wedding-success btn-action" id="exportCredentials">
                            <i class="bi bi-download me-2"></i>Export
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Haupttabelle -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="bi bi-table me-2"></i>
                    Gast-Credentials Übersicht
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="credentialsTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Gast</th>
                                <th>E-Mail</th>
                                <th>Login-Code</th>
                                <th>Passwort</th>
                                <th>Status</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="credentialsTableBody">
                            <!-- Wird via JavaScript befüllt -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer text-muted">
                <small>
                    <i class="bi bi-info-circle me-1"></i>
                    Credentials werden automatisch generiert und sind sofort nutzbar.
                </small>
            </div>
        </div>
    </div>
</div>



<!-- Toast Notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="successToast" class="toast bg-success text-white" role="alert">
        <div class="toast-header bg-success text-white">
            <i class="bi bi-check-circle me-2"></i>
            <strong class="me-auto">Erfolg</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="successMessage">Aktion erfolgreich!</div>
    </div>
    
    <div id="errorToast" class="toast bg-danger text-white" role="alert">
        <div class="toast-header bg-danger text-white">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong class="me-auto">Fehler</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="errorMessage">Es ist ein Fehler aufgetreten!</div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="position-fixed top-50 start-50 translate-middle d-none">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Laden...</span>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Sofortige Test-Ausgabe

    

    let allCredentials = [];

    // Teste ob das DOM bereit ist
    if (document.readyState === 'loading') {

        document.addEventListener('DOMContentLoaded', function() {

            loadCredentials();
            
            // Event Listeners
            document.getElementById('generateCredentials').addEventListener('click', generateAllCredentials);
            document.getElementById('refreshCredentials').addEventListener('click', loadCredentials);
            document.getElementById('exportCredentials').addEventListener('click', exportCredentials);
            document.getElementById('searchInput').addEventListener('input', filterCredentials);
        });
    } else {

        loadCredentials();
        
        // Event Listeners
        document.getElementById('generateCredentials').addEventListener('click', generateAllCredentials);
        document.getElementById('refreshCredentials').addEventListener('click', loadCredentials);
        document.getElementById('exportCredentials').addEventListener('click', exportCredentials);
        document.getElementById('searchInput').addEventListener('input', filterCredentials);
    }

    function showLoading() {
        document.getElementById('loadingSpinner').classList.remove('d-none');
    }

    function hideLoading() {
        document.getElementById('loadingSpinner').classList.add('d-none');
    }

    function loadCredentials() {

        showLoading();
        
        fetch('/api/admin/guest-credentials')
            .then(response => {

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // Prüfe Content-Type
                const contentType = response.headers.get('content-type');

                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Server hat kein JSON zurückgegeben. Möglicherweise ist die Session abgelaufen.');
                }
                
                return response.json();
            })
            .then(data => {

                hideLoading();
                if (data && data.success) {

                    allCredentials = data.credentials || [];
                    displayCredentials(allCredentials);
                    updateStats();
                } else {

                    showError('Fehler beim Laden der Credentials: ' + (data?.message || 'Unbekannter Fehler'));
                }
            })
            .catch(error => {

                hideLoading();
                if (error.message.includes('Session abgelaufen')) {
                    showError('Session abgelaufen. Bitte melden Sie sich erneut an.');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 3000);
                } else {
                    showError('Fehler beim Laden der Credentials: ' + error.message);
                }
            });
    }

    function displayCredentials(credentials) {

        const tbody = document.getElementById('credentialsTableBody');
        
        if (credentials.length === 0) {

            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                        <i class="bi bi-inbox display-4 d-block mb-2"></i>
                        Keine Gäste gefunden
                    </td>
                </tr>
            `;
            return;
        }


        const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
        
        tbody.innerHTML = credentials.map(guest => {
            const name = `${guest.vorname || ''} ${guest.nachname || ''}`.trim();
            const email = guest.email || 'Keine E-Mail';
            const loginCode = guest.login_code || 'Nicht generiert';
            const password = guest.password || 'Nicht generiert';
            
            // Highlighting für Suchbegriffe
            const highlightedName = searchTerm ? highlightSearchTerm(name, searchTerm) : name;
            const highlightedEmail = searchTerm ? highlightSearchTerm(email, searchTerm) : email;
            const highlightedCode = searchTerm ? highlightSearchTerm(loginCode, searchTerm) : loginCode;
            
            const hasCredentials = guest.login_code && guest.password;
            const statusBadge = hasCredentials 
                ? '<span class="badge badge-wedding-success">Generiert</span>'
                : '<span class="badge badge-wedding-warning">Ausstehend</span>';
                
            return `
                <tr class="credential-card-row">
                    <td>
                        <div class="fw-semibold">${highlightedName}</div>
                    </td>
                    <td>${highlightedEmail}</td>
                    <td>
                        ${hasCredentials ? `
                            <code class="generated-credential">${highlightedCode}</code>
                            <button class="btn btn-outline-primary btn-sm ms-2 copy-btn" 
                                    onclick="copyToClipboard('${loginCode}')" title="Kopieren">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        ` : '<span class="text-muted">-</span>'}
                    </td>
                    <td>
                        ${hasCredentials ? `
                            <code class="generated-credential">${password}</code>
                            <button class="btn btn-outline-primary btn-sm ms-2 copy-btn" 
                                    onclick="copyToClipboard('${password}')" title="Kopieren">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        ` : '<span class="text-muted">-</span>'}
                    </td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-info" 
                                    onclick="copyGuestCredentials('${name}', '${loginCode}', '${password}')" 
                                    title="Alle Daten kopieren"
                                    ${!hasCredentials ? 'disabled' : ''}>
                                <i class="bi bi-copy"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function updateStats() {
        const total = allCredentials.length;
        const withCredentials = allCredentials.filter(guest => guest.login_code && guest.password).length;
        
        document.getElementById('totalGuests').textContent = total;
        document.getElementById('credentialsGenerated').textContent = withCredentials;
    }

    function generateAllCredentials() {
        if (!confirm('Möchten Sie wirklich für alle Gäste neue Credentials generieren? Bestehende Credentials werden überschrieben.')) {
            return;
        }
        
        showLoading();
        
        fetch('/api/admin/generate-guest-credentials', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Server hat kein JSON zurückgegeben. Möglicherweise ist die Session abgelaufen.');
            }
            
            return response.json();
        })
        .then(data => {
            hideLoading();
            if (data && data.success) {
                showSuccess('Credentials für alle Gäste erfolgreich generiert!');
                loadCredentials();
            } else {
                showError('Fehler beim Generieren: ' + (data?.message || 'Unbekannter Fehler'));
            }
        })
        .catch(error => {
            hideLoading();

            if (error.message.includes('Session abgelaufen')) {
                showError('Session abgelaufen. Bitte melden Sie sich erneut an.');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 3000);
            } else {
                showError('Fehler beim Generieren der Credentials: ' + error.message);
            }
        });
    }

    function exportCredentials() {
        if (allCredentials.length === 0) {
            showError('Keine Credentials zum Exportieren vorhanden');
            return;
        }
        
        const csv = createCSV(allCredentials);
        const filename = `gaeste-credentials-${new Date().toISOString().split('T')[0]}.csv`;
        downloadCSV(csv, filename);
        showSuccess('CSV-Datei wurde heruntergeladen');
    }

    function createCSV(credentials) {
        const header = 'Vorname,Nachname,Login-Code,Passwort,E-Mail,Status\n';
        const rows = credentials.map(guest => {
            const hasCredentials = guest.login_code && guest.password;
            const status = hasCredentials ? 'Generiert' : 'Ausstehend';
            return `"${guest.vorname || ''}","${guest.nachname || ''}","${guest.login_code || ''}","${guest.password || ''}","${guest.email || ''}","${status}"`;
        }).join('\n');
        
        return header + rows;
    }

    function downloadCSV(csv, filename) {
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function() {
            showSuccess('In Zwischenablage kopiert!');
        }, function(err) {

            showError('Fehler beim Kopieren');
        });
    }

    function copyGuestCredentials(name, loginCode, password) {
        const text = `Gast: ${name}\nLogin-Code: ${loginCode}\nPasswort: ${password}`;
        copyToClipboard(text);
    }

    function filterCredentials() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
        
        if (searchTerm === '') {
            displayCredentials(allCredentials);
        } else {
            const filtered = allCredentials.filter(guest => {
                const fullName = `${guest.vorname || ''} ${guest.nachname || ''}`.toLowerCase();
                const email = (guest.email || '').toLowerCase();
                const loginCode = (guest.login_code || '').toLowerCase();
                
                return fullName.includes(searchTerm) || 
                       email.includes(searchTerm) || 
                       loginCode.includes(searchTerm);
            });
            
            displayCredentials(filtered);
        }
    }

    function highlightSearchTerm(text, searchTerm) {
        if (!text || !searchTerm) {
            return text;
        }
        
        const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
        return text.replace(regex, '<span class="search-highlight">$1</span>');
    }

    function showSuccess(message) {
        document.getElementById('successMessage').textContent = message;
        new bootstrap.Toast(document.getElementById('successToast')).show();
    }

    function showError(message) {
        document.getElementById('errorMessage').textContent = message;
        new bootstrap.Toast(document.getElementById('errorToast')).show();
    }
</script>
{% endblock %}

