<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Upload Loader</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="card">
            <div class="card-header">
                <h5>Upload Loading Debug</h5>
            </div>
            <div class="card-body">
                <button type="button" class="btn btn-primary" onclick="testCreateUploadCard()">
                    Test Upload Card Creation
                </button>
                <button type="button" class="btn btn-secondary ms-2" onclick="testLoadMyUploads()">
                    Test Load My Uploads
                </button>
                
                <div id="debugOutput" class="mt-3"></div>
                <div id="myUploadsContainer" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Test data with various scenarios
        const testUploads = [
            {
                id: 1,
                original_filename: "test.jpg",
                file_size: 1234567,
                mime_type: "image/jpeg",
                upload_date: "2024-01-01 12:00:00",
                beschreibung: "Test description"
            },
            {
                id: 2,
                original_filename: null,
                file_size: 987654,
                mime_type: "video/mp4",
                upload_date: "2024-01-02 13:00:00",
                beschreibung: null
            },
            {
                id: 3,
                original_filename: undefined,
                file_size: 555555,
                mime_type: undefined,
                upload_date: "2024-01-03 14:00:00",
                beschreibung: "Another test"
            },
            {
                id: 4,
                original_filename: "file with 'quotes' and \"double quotes\".pdf",
                file_size: 333333,
                mime_type: "application/pdf",
                upload_date: "2024-01-04 15:00:00",
                beschreibung: null
            }
        ];

        // Helper functions
        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            if (!dateString) return 'Unknown date';
            try {
                return new Date(dateString).toLocaleDateString('de-DE');
            } catch (e) {
                return 'Invalid date';
            }
        }

        // Copy of the updated createUploadCard function
        function createUploadCard(upload) {
            const card = document.createElement('div');
            card.className = 'card mb-3';
            
            // Sichere Verarbeitung der Datei-Eigenschaften
            const safeFileName = upload.original_filename || 'Unbenannte Datei';
            const safeMimeType = upload.mime_type || 'application/octet-stream';
            const safeDescription = upload.beschreibung || '';
            
            // Bestimme Icon und Typ
            const isImage = safeMimeType.startsWith('image/');
            const isVideo = safeMimeType.startsWith('video/');
            
            let icon = 'bi-file-earmark';
            let typeText = 'Datei';
            
            if (isImage) {
                icon = 'bi-image';
                typeText = 'Bild';
            } else if (isVideo) {
                icon = 'bi-play-circle';
                typeText = 'Video';
            }
            
            // Sichere Verarbeitung für onclick-Handler - Filename für Modal escapen
            const escapedFileName = safeFileName.replace(/'/g, "\\'").replace(/"/g, '\\"');
            
            card.innerHTML = `
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-2 col-md-1 text-center">
                            <i class="bi ${icon}" style="font-size: 2rem; color: #d4af37;"></i>
                        </div>
                        <div class="col-7 col-md-8">
                            <h6 class="mb-1">${safeFileName}</h6>
                            <p class="mb-1 text-muted small">
                                ${typeText} • ${formatFileSize(upload.file_size)} • ${formatDate(upload.upload_date)}
                            </p>
                            ${safeDescription ? `<p class="mb-0 small text-secondary">${safeDescription}</p>` : ''}
                        </div>
                        <div class="col-3 col-md-3 text-end">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary" onclick="alert('View: ${upload.id}')" title="Anzeigen">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button type="button" class="btn btn-outline-success" onclick="alert('Download: ${upload.id}')" title="Herunterladen">
                                    <i class="bi bi-download"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger" onclick="alert('Delete: ${upload.id}, File: ${escapedFileName}')" title="Löschen">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }

        function testCreateUploadCard() {
            const debugOutput = document.getElementById('debugOutput');
            debugOutput.innerHTML = '<h6>Testing Upload Card Creation:</h6>';
            
            testUploads.forEach((upload, index) => {
                try {
                    console.log(`Creating card for upload ${index}:`, upload);
                    const card = createUploadCard(upload);
                    debugOutput.appendChild(card);
                    
                    const successMsg = document.createElement('div');
                    successMsg.className = 'alert alert-success';
                    successMsg.textContent = `✓ Upload ${index + 1} card created successfully`;
                    debugOutput.appendChild(successMsg);
                } catch (error) {
                    console.error(`Error creating card ${index}:`, error, upload);
                    
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'alert alert-danger';
                    errorMsg.textContent = `✗ Upload ${index + 1} failed: ${error.message}`;
                    debugOutput.appendChild(errorMsg);
                }
            });
        }

        function testLoadMyUploads() {
            const container = document.getElementById('myUploadsContainer');
            container.innerHTML = '<h6>Testing Load My Uploads Logic:</h6>';
            
            // Simulate the loadMyUploads logic
            try {
                const uploads = testUploads; // Simulate API response
                
                console.log('Uploads received:', uploads);
                
                if (!uploads || uploads.length === 0) {
                    container.innerHTML += `
                        <div class="text-center py-4">
                            <i class="bi bi-cloud-upload text-muted" style="font-size: 3rem;"></i>
                            <h6 class="text-muted mt-3">Noch keine Uploads</h6>
                            <p class="text-muted small">Du hast noch keine Dateien hochgeladen.</p>
                        </div>
                    `;
                    return;
                }
                
                // Uploads anzeigen
                uploads.forEach((upload, index) => {
                    try {
                        console.log(`Processing upload ${index}:`, upload);
                        const uploadCard = createUploadCard(upload);
                        container.appendChild(uploadCard);
                    } catch (cardError) {
                        console.error(`Error creating card for upload ${index}:`, cardError, upload);
                        
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'alert alert-warning';
                        errorDiv.textContent = `Error processing upload ${index}: ${cardError.message}`;
                        container.appendChild(errorDiv);
                    }
                });
                
            } catch (error) {
                console.error('Error in loadMyUploads:', error);
                container.innerHTML += `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Fehler beim Laden der Uploads: ${error.message}
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
