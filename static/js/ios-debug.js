/**
 * iOS Safari Debug Helper
 * Zeigt Debug-Informationen direkt auf der Webseite an
 */

class IOSDebugHelper {
    constructor() {
        this.debugElement = null;
        this.init();
    }

    init() {
        // Debug-Container erstellen
        this.createDebugContainer();
        
        // Sofort iOS-Infos anzeigen
        this.showIOSInfo();
        
        // Push Notification Test starten
        this.testPushNotifications();
        
        // Push Notification Button Events abfangen
        this.interceptPushNotificationEvents();
    }

    createDebugContainer() {
        // Debug-Container erstellen
        this.debugElement = document.createElement('div');
        this.debugElement.id = 'ios-debug-info';
        this.debugElement.style.cssText = `
            position: fixed;
            bottom: 10px;
            left: 10px;
            right: 10px;
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0,0,0,0.9);
            color: #00ff00;
            font-family: monospace;
            font-size: 10px;
            padding: 10px;
            border-radius: 5px;
            z-index: 8888;
            border: 1px solid #333;
        `;

        // Schlie√üen-Button
        const closeBtn = document.createElement('button');
        closeBtn.textContent = '‚ùå';
        closeBtn.style.cssText = `
            position: absolute;
            top: 2px;
            right: 2px;
            background: #ff4444;
            color: white;
            border: none;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 8px;
            cursor: pointer;
        `;
        closeBtn.onclick = () => this.debugElement.style.display = 'none';
        
        this.debugElement.appendChild(closeBtn);
        document.body.appendChild(this.debugElement);
    }

    log(message) {
        const timestamp = new Date().toLocaleTimeString();
        const logLine = document.createElement('div');
        logLine.textContent = `[${timestamp}] ${message}`;
        logLine.style.marginBottom = '2px';
        this.debugElement.appendChild(logLine);
        
        // Auto-scroll nach unten
        this.debugElement.scrollTop = this.debugElement.scrollHeight;
        
        // Auch in normale Konsole loggen
        console.log(message);
    }

    showIOSInfo() {
        this.log('üçé iOS Safari Debug-Informationen:');
        this.log('================================');
        
        // User Agent
        this.log(`üì± User Agent: ${navigator.userAgent}`);
        
        // iOS Detection
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        this.log(`üçé iOS erkannt: ${isIOS ? 'JA' : 'NEIN'}`);
        
        if (isIOS) {
            // iOS Version detailliert
            const iOSVersion = navigator.userAgent.match(/OS (\d+)_(\d+)(?:_(\d+))?/);
            if (iOSVersion) {
                const majorVersion = parseInt(iOSVersion[1]);
                const minorVersion = parseInt(iOSVersion[2]);
                const patchVersion = iOSVersion[3] ? parseInt(iOSVersion[3]) : 0;
                this.log(`üì± iOS Version: ${majorVersion}.${minorVersion}.${patchVersion}`);
                
                // Detaillierte Version-Checks
                if (majorVersion < 16) {
                    this.log('‚ùå iOS Version ZU ALT! Web Push ben√∂tigt iOS 16.4+');
                    this.log('üí° L√∂sung: iOS auf mindestens 16.4 aktualisieren');
                } else if (majorVersion === 16 && minorVersion < 4) {
                    this.log(`‚ùå iOS 16.${minorVersion} ZU ALT! Web Push ben√∂tigt iOS 16.4+`);
                    this.log('üí° L√∂sung: iOS auf mindestens 16.4 aktualisieren');
                } else {
                    this.log(`‚úÖ iOS ${majorVersion}.${minorVersion}.${patchVersion} sollte Web Push unterst√ºtzen`);
                }
                
                // Safari Version aus User Agent extrahieren
                const safariVersion = navigator.userAgent.match(/Version\/(\d+)\.(\d+)/);
                if (safariVersion) {
                    const safariMajor = parseInt(safariVersion[1]);
                    const safariMinor = parseInt(safariVersion[2]);
                    this.log(`üåê Safari Version: ${safariMajor}.${safariMinor}`);
                    
                    if (safariMajor < 16) {
                        this.log('‚ùå Safari Version zu alt f√ºr Web Push!');
                    }
                }
            } else {
                this.log('‚ö†Ô∏è iOS Version konnte nicht ermittelt werden');
            }
            
            // iPhone Modell versuchen zu ermitteln
            if (navigator.userAgent.includes('iPhone')) {
                this.log('üì± Ger√§t: iPhone');
                // Zus√§tzliche iPhone-spezifische Checks
                this.log('üí° Web Push auf iPhone ben√∂tigt:');
                this.log('   - iOS 16.4 oder h√∂her');
                this.log('   - Safari als Standard-Browser');
                this.log('   - Push Notifications in Safari-Einstellungen aktiviert');
            }
        }
        
        // Safari Detection
        const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
        this.log(`üåê Safari Browser: ${isSafari ? 'JA' : 'NEIN'}`);
        
        if (!isSafari) {
            this.log('‚ùå Kein Safari! Web Push auf iOS funktioniert NUR in Safari!');
            this.log('üí° L√∂sung: Website in Safari √∂ffnen');
        }
        
        // Protocol Check
        this.log(`üîí Protocol: ${window.location.protocol}`);
        this.log(`üåê URL: ${window.location.href}`);
        this.log(`üîê Secure Context: ${isSecureContext ? 'JA' : 'NEIN'}`);
        
        // Screen Infos f√ºr weitere Diagnose
        this.log(`üì∫ Screen: ${screen.width}x${screen.height}`);
        this.log(`üñºÔ∏è Viewport: ${window.innerWidth}x${window.innerHeight}`);
        
        this.log('================================');
    }

    async testPushNotifications() {
        this.log('üîß Push Notification Test startet...');
        
        // Warte 2 Sekunden, damit Service Worker Zeit hat sich zu registrieren
        this.log('‚è≥ Warte 2 Sekunden auf Service Worker...');
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        try {
            // Service Worker Check
            const hasServiceWorker = 'serviceWorker' in navigator;
            this.log(`‚öôÔ∏è Service Worker: ${hasServiceWorker ? '‚úÖ Verf√ºgbar' : '‚ùå Nicht verf√ºgbar'}`);
            
            // PushManager Check (initial)
            const hasPushManager = 'PushManager' in window;
            this.log(`üì¨ PushManager (initial): ${hasPushManager ? '‚úÖ Verf√ºgbar' : '‚ùå Nicht verf√ºgbar'}`);
            
            // Notification Check
            const hasNotification = 'Notification' in window;
            this.log(`üîî Notification API: ${hasNotification ? '‚úÖ Verf√ºgbar' : '‚ùå Nicht verf√ºgbar'}`);
            
            if (!hasServiceWorker) {
                this.log('‚ùå Service Worker nicht verf√ºgbar - Push Notifications unm√∂glich');
                return;
            }
            
            // WICHTIG: Auf iOS m√ºssen sowohl PushManager als auch Notification API verf√ºgbar sein
            if (!hasPushManager && !hasNotification) {
                this.log('üçé DIAGNOSE: Keine Push APIs verf√ºgbar');
                this.log('üìä M√∂gliche Ursachen:');
                this.log('   1Ô∏è‚É£ iOS Version zu alt (< 16.4)');
                this.log('   2Ô∏è‚É£ Safari-Einstellungen: Push deaktiviert');
                this.log('   3Ô∏è‚É£ Nicht in Safari ge√∂ffnet');
                this.log('   4Ô∏è‚É£ Website nicht als Lesezeichen/Home Screen hinzugef√ºgt');
                this.log('');
                this.log('üí° L√ñSUNG VERSUCHEN:');
                this.log('   1Ô∏è‚É£ Pr√ºfen: Einstellungen ‚Üí Safari ‚Üí Erweitert');
                this.log('   2Ô∏è‚É£ "Entwickler-Funktionen" aktivieren');
                this.log('   3Ô∏è‚É£ Website zu Home Screen hinzuf√ºgen');
                this.log('   4Ô∏è‚É£ Als PWA installieren (Share ‚Üí Zum Home-Bildschirm)');
                return;
            }
            
            // Service Worker Registration
            this.log('üîÑ Registriere Service Worker...');
            
            try {
                // Pr√ºfe ob Service Worker bereits registriert ist
                const existingRegistration = await navigator.serviceWorker.getRegistration();
                this.log(`üîç Vorhandene SW Registration: ${existingRegistration ? 'JA' : 'NEIN'}`);
                
                if (existingRegistration) {
                    this.log(`üìã SW State: ${existingRegistration.active ? existingRegistration.active.state : 'Kein aktiver SW'}`);
                    this.log(`üìÇ SW Script URL: ${existingRegistration.active ? existingRegistration.active.scriptURL : 'Unbekannt'}`);
                }
                
                // Versuche Service Worker zu registrieren falls nicht vorhanden
                if (!existingRegistration) {
                    this.log('üìù Registriere neuen Service Worker...');
                    try {
                        // KORREKTUR: Scope muss im gleichen Pfad oder unterhalb des SW Scripts sein
                        const newRegistration = await navigator.serviceWorker.register('/static/sw.js', {
                            scope: '/static/'  // Scope auf /static/ setzen statt /
                        });
                        this.log('‚úÖ Service Worker neu registriert');
                        this.log(`üìÇ Scope: ${newRegistration.scope}`);
                        
                        // Alternativ: Registrierung ohne expliziten Scope
                        // scope wird automatisch auf den Ordner des SW Scripts gesetzt
                    } catch (regError) {
                        this.log(`‚ùå Service Worker Registrierung fehlgeschlagen: ${regError.message}`);
                        
                        // Versuche ohne expliziten Scope
                        this.log('ÔøΩ Versuche Registration ohne expliziten Scope...');
                        try {
                            const fallbackRegistration = await navigator.serviceWorker.register('/static/sw.js');
                            this.log('‚úÖ Service Worker mit automatischem Scope registriert');
                            this.log(`üìÇ Auto-Scope: ${fallbackRegistration.scope}`);
                        } catch (fallbackError) {
                            this.log(`‚ùå Auch Fallback-Registration fehlgeschlagen: ${fallbackError.message}`);
                            
                            // Pr√ºfe ob sw.js erreichbar ist
                            try {
                                const response = await fetch('/static/sw.js');
                                if (response.ok) {
                                    this.log('‚úÖ sw.js Datei ist erreichbar');
                                } else {
                                    this.log(`‚ùå sw.js nicht erreichbar: ${response.status} ${response.statusText}`);
                                }
                            } catch (fetchError) {
                                this.log(`‚ùå sw.js fetch Fehler: ${fetchError.message}`);
                            }
                            return;
                        }
                    }
                } else {
                    this.log('üìã Verwende vorhandene Service Worker Registration');
                }
                
                // Warte auf Service Worker Ready mit Timeout
                this.log('‚è≥ Warte auf Service Worker Ready...');
                
                let registration;
                try {
                    // Service Worker Ready mit 10 Sekunden Timeout
                    registration = await Promise.race([
                        navigator.serviceWorker.ready,
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Service Worker Ready Timeout nach 10 Sekunden')), 10000)
                        )
                    ]);
                    this.log('‚úÖ Service Worker bereit');
                } catch (timeoutError) {
                    this.log(`‚ùå Service Worker Ready Timeout: ${timeoutError.message}`);
                    this.log('üí° Versuche alternative Service Worker Zugriff...');
                    
                    // Alternative: Vorhandene Registration verwenden
                    const existingReg = await navigator.serviceWorker.getRegistration();
                    if (existingReg && existingReg.active) {
                        registration = existingReg;
                        this.log('‚úÖ Verwende existierende Service Worker Registration');
                    } else {
                        this.log('‚ùå Keine funktionierende Service Worker Registration gefunden');
                        this.log('üí° L√∂sung: Seite neu laden oder Service Worker neu installieren');
                        return;
                    }
                }
                
                // Detaillierte SW Info
                if (registration.active) {
                    this.log(`üìã Aktiver SW State: ${registration.active.state}`);
                    this.log(`üìÇ SW Script: ${registration.active.scriptURL}`);
                    this.log(`üåê SW Scope: ${registration.scope}`);
                } else {
                    this.log('‚ö†Ô∏è Kein aktiver Service Worker gefunden');
                }
                
                // PushManager nach Registration pr√ºfen
                const hasPushManagerAfterSW = !!registration.pushManager;
                this.log(`üì¨ PushManager (nach SW): ${hasPushManagerAfterSW ? '‚úÖ Verf√ºgbar' : '‚ùå Nicht verf√ºgbar'}`);
                
                if (!hasPushManagerAfterSW) {
                    this.log('‚ùå PushManager nicht verf√ºgbar nach Service Worker Registration');
                    this.log('üí° M√∂gliche Ursache: Service Worker nicht korrekt geladen');
                    return;
                }
                
                // Notification Permission Status pr√ºfen
                this.log(`üîî Aktuelle Permission: ${Notification.permission}`);
                
                if (Notification.permission === 'default') {
                    this.log('üîî Frage nach Notification Permission...');
                    
                    // iOS spezielle Behandlung f√ºr Permission Request
                    this.log('üçé iOS: Starte Permission Request (User Gesture erforderlich)...');
                    
                    try {
                        const permission = await Notification.requestPermission();
                        this.log(`üîî Permission Ergebnis: ${permission}`);
                        
                        if (permission === 'granted') {
                            this.log('‚úÖ Permission erhalten!');
                        } else if (permission === 'denied') {
                            this.log('‚ùå Permission verweigert');
                            this.log('üí° L√∂sung: Safari-Einstellungen ‚Üí Websites ‚Üí Benachrichtigungen');
                        } else {
                            this.log(`‚ö†Ô∏è Unerwartetes Permission-Ergebnis: ${permission}`);
                        }
                    } catch (permError) {
                        this.log(`‚ùå Fehler bei Permission Request: ${permError.message}`);
                        this.log('üí° M√∂gliche Ursache: Kein User Gesture oder Safari-Einstellungen');
                    }
                    
                } else if (Notification.permission === 'granted') {
                    this.log('‚úÖ Permission bereits erteilt!');
                } else if (Notification.permission === 'denied') {
                    this.log('‚ùå Permission bereits verweigert');
                    this.log('üí° L√∂sung: Safari-Einstellungen ‚Üí Websites ‚Üí Benachrichtigungen ‚Üí Diese Website');
                }
                
                // Final Status
                if (Notification.permission === 'granted') {
                    this.log('üéâ Alle Push Notification Voraussetzungen erf√ºllt!');
                    this.log('‚úÖ Push Notifications sollten funktionieren');
                    
                    // Test-Subscription versuchen
                    this.log('üß™ Teste Subscription-Erstellung...');
                    try {
                        // Dummy VAPID key f√ºr Test (wird nicht verwendet)
                        const testKey = 'BMxiMgfSLdQSL-LqSFMr-mZqbhf4Z4qV4W8l4J8s_x-yE9YcGlS0Ej2A9xR8Y1dP_3X5a7uj2V3bA_ZxK8N9L2G4M';
                        const testSubscription = await registration.pushManager.subscribe({
                            userVisibleOnly: true,
                            applicationServerKey: this.urlBase64ToUint8Array(testKey)
                        });
                        this.log('‚úÖ Test-Subscription erfolgreich erstellt!');
                        this.log('üîß Push Notifications sind vollst√§ndig funktionsf√§hig');
                        
                        // Test-Subscription wieder l√∂schen
                        await testSubscription.unsubscribe();
                        this.log('üßπ Test-Subscription entfernt');
                        
                    } catch (subError) {
                        this.log(`‚ö†Ô∏è Test-Subscription fehlgeschlagen: ${subError.message}`);
                        this.log('üí° Das k√∂nnte normal sein - echter Test mit echtem VAPID Key n√∂tig');
                    }
                    
                } else {
                    this.log(`‚ùå Permission nicht erteilt: ${Notification.permission}`);
                }
                
            } catch (swError) {
                this.log(`‚ùå Service Worker Registration Fehler: ${swError.message}`);
                this.log('üí° M√∂gliche Ursachen:');
                this.log('   - Service Worker-Datei nicht gefunden (/static/sw.js)');
                this.log('   - Netzwerkfehler');
                this.log('   - Safari-Sicherheitseinstellungen');
                this.log(`üìä Fehler-Details: ${swError.toString()}`);
            }
            
        } catch (error) {
            this.log(`‚ùå Fehler beim Push Notification Test: ${error.message}`);
            this.log(`üìä Error Details: ${error.toString()}`);
        }
    }
    
    // Hilfsfunktion f√ºr VAPID Key Konvertierung
    urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
            .replace(/-/g, '+')
            .replace(/_/g, '/');
        
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        
        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }
    
    // Intercept Push Notification Events
    interceptPushNotificationEvents() {
        this.log('üîß √úberwache Push Notification Events...');
        
        // Warte auf Push Banner und √ºberwache Aktivieren Button
        const checkForPushButton = () => {
            const pushBtn = document.querySelector('#enablePushBtn');
            if (pushBtn && !pushBtn.dataset.debugIntercepted) {
                this.log('üîß Push Aktivieren Button gefunden - f√ºge Debug hinzu');
                pushBtn.dataset.debugIntercepted = 'true';
                
                // Original Click Handler √ºberwachen
                pushBtn.addEventListener('click', (event) => {
                    this.log('üîî PUSH AKTIVIEREN BUTTON GEKLICKT!');
                    this.log('üì± Starte detaillierte Push Activation √úberwachung...');
                    
                    // √úberwache alle fetch Requests
                    const originalFetch = window.fetch;
                    window.fetch = async (...args) => {
                        const url = args[0];
                        const options = args[1] || {};
                        
                        this.log(`üåê FETCH: ${url}`);
                        this.log(`üìä METHOD: ${options.method || 'GET'}`);
                        
                        try {
                            const response = await originalFetch(...args);
                            this.log(`‚úÖ FETCH Response: ${response.status} ${response.statusText}`);
                            
                            // Restore original fetch nach 10 Sekunden
                            setTimeout(() => {
                                window.fetch = originalFetch;
                                this.log('üîß Fetch Monitoring beendet');
                            }, 10000);
                            
                            return response;
                        } catch (error) {
                            this.log(`‚ùå FETCH Error: ${error.message}`);
                            window.fetch = originalFetch;
                            throw error;
                        }
                    };
                }, true); // Capture phase
            }
        };
        
        // Pr√ºfe alle 500ms nach Push Button
        const intervalId = setInterval(() => {
            checkForPushButton();
            
            // Nach 30 Sekunden aufh√∂ren zu suchen
            setTimeout(() => clearInterval(intervalId), 30000);
        }, 500);
    }
}

// Auto-start wenn Seite geladen
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        new IOSDebugHelper();
    });
} else {
    new IOSDebugHelper();
}
